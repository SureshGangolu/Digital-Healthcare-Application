<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #212529;
            --secondary: #495057;
            --light: #f8f9fa;
            --card-radius: 8px;
        }
        
        body {
            background-color: #f5f7fb;
            color: #495057;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 1rem;
        }
        
        .chat-wrap {
            max-width: 860px;
            margin: 0 auto;
        }
        
        .chat-card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1rem 1.5rem;
            font-weight: 600;
            border-radius: var(--card-radius) var(--card-radius) 0 0 !important;
        }
        
        #chatbox {
            height: 360px;
            overflow-y: auto;
            background: #fff;
            padding: 1rem;
            border-radius: var(--card-radius);
        }
        
        .msg {
            margin: 0 0 1rem 0;
        }
        
        .msg .who {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--secondary);
            margin-bottom: 0.25rem;
        }
        
        .bubble {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: #f1f4f9;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .mine .bubble {
            background: #e3f2fd;
        }
        
        .file-img {
            max-width: 220px;
            border-radius: 8px;
            margin-top: 0.5rem;
        }
        
        .composer {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .composer input[type="text"] {
            flex: 1;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            padding: 0.75rem;
        }
        
        .uploader {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .sticky-footer {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 1rem;
            border-top: 1px solid #eceff5;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.75rem 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }
        
        .btn-outline-dark {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-outline-dark:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .form-select, .form-control {
            border-radius: 6px;
            border: 1px solid #e9ecef;
            padding: 0.5rem 1rem;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const bid = "{{ b.id }}";
            const me = "{{ request.user.username }}";
            const socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + bid + '/');

            const chatbox = document.getElementById('chatbox');
            const msgInput = document.getElementById('msg');
            const sendBtn  = document.getElementById('sendBtn');

            function appendMessage(sender, message, fileUrl) {
                const isMine = sender === me;
                let html = `<div class="msg ${isMine ? 'mine' : ''}">
                              <div class="who">${sender}</div>
                              ${message ? `<div class="bubble">${escapeHtml(message)}</div>` : ''}`;

                if (fileUrl) {
                    const ext = fileUrl.split('.').pop().toLowerCase();
                    const isImage = ['jpg','jpeg','png','gif','webp'].includes(ext);
                    
                    if (isImage) {
                        html += `
                            <div>
                                <img class="file-img" src="${fileUrl}" alt="file">
                                <div class="mt-2">
                                    <a href="${fileUrl}" download class="btn btn-sm btn-outline-dark">
                                        <i class="bi bi-download"></i> Download Image
                                    </a>
                                </div>
                            </div>`;
                    } else {
                        html += `
                            <div class="mt-2">
                                <a href="${fileUrl}" download class="btn btn-sm btn-outline-dark">
                                    <i class="bi bi-download"></i> Download File
                                </a>
                            </div>`;
                    }
                }
                html += `</div>`;
                chatbox.insertAdjacentHTML('beforeend', html);
                chatbox.scrollTop = chatbox.scrollHeight;
            }

            function escapeHtml(str){
                return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            }

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data || '{}');
                appendMessage(data.sender || 'user', data.message || '', data.file_url || '');
            };

            function sendMessage() {
                const msg = msgInput.value.trim();
                if (!msg) return;
                socket.send(JSON.stringify({ message: msg }));
                msgInput.value = '';
            }

            sendBtn.addEventListener('click', sendMessage);
            msgInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            const fileForm = document.getElementById("file-upload-form");
            const fileInput = document.getElementById("fileInput");
            const fileType  = document.getElementById("fileType");

            fileForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) return;

                const label = fileType.value || 'File';
                const formData = new FormData();
                formData.append("file", file);
                formData.append("bid", bid);

                const res = await fetch("/upload-file/", { method: "POST", body: formData });
                const data = await res.json();
                
                if (data.file_url) {
                    const prettyName = file.name || 'attachment';
                    const labelMessage = `[${label}] ${prettyName}`;
                    socket.send(JSON.stringify({ message: labelMessage, file_url: data.file_url }));
                    fileInput.value = "";
                    fileType.selectedIndex = 0;
                }
            });
        });
    </script>
</head>
<body>
<div class="chat-wrap">
    <div class="card chat-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Live Chat</h5>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-dark">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>

        <div class="card-body">
            <div id="chatbox">
                {% for m in msgs %}
                    <div class="msg {% if m.sender.user.username == request.user.username %}mine{% endif %}">
                        <div class="who">{{ m.sender.user.username }}</div>
                        {% if m.message %}
                            <div class="bubble">{{ m.message }}</div>
                        {% endif %}

                        {% if m.file %}
                            {% with m.file.url|lower as f %}
                                {% if f|slice:"-4:" == ".jpg" or f|slice:"-4:" == ".png" or f|slice:"-5:" == ".jpeg" or f|slice:"-4:" == ".gif" or f|slice:"-5:" == ".webp" %}
                                    <div><img class="file-img" src="{{ m.file.url }}" alt="Image"></div>
                                {% else %}
                                    <div class="mt-2">
                                        <a href="{{ m.file.url }}" download class="btn btn-sm btn-outline-dark">
                                            <i class="bi bi-download"></i> Download File
                                        </a>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="sticky-footer">
            <div class="composer">
                <input id="msg" type="text" class="form-control" placeholder="Type a message…" />
                <button id="sendBtn" class="btn btn-primary">
                    <i class="bi bi-send"></i> Send
                </button>
            </div>

            <form id="file-upload-form" enctype="multipart/form-data" class="uploader">
                <select id="fileType" class="form-select" style="max-width:220px;">
                    <option value="" selected>Label file…</option>
                    <option value="Prescription">Prescription</option>
                    <option value="Lab report">Lab report</option>
                    <option value="Referral">Referral</option>
                    <option value="Document">Document</option>
                    <option value="Other">Other</option>
                </select>
                <input type="file" id="fileInput" name="file" class="form-control" style="max-width:340px;">
                <button type="submit" class="btn btn-outline-dark">
                    <i class="bi bi-paperclip"></i> Send File
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>